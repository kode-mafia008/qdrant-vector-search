services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant_vector_db
    env_file:
      - .env
    environment:
      # S3 Storage Configuration (only used if USE_S3_STORAGE=true in .env)
      - QDRANT__STORAGE__SNAPSHOTS__S3__BUCKET=${S3_BUCKET:-}
      - QDRANT__STORAGE__SNAPSHOTS__S3__REGION=${S3_REGION:-}
      - QDRANT__STORAGE__SNAPSHOTS__S3__ACCESS_KEY=${AWS_ACCESS_KEY_ID:-}
      - QDRANT__STORAGE__SNAPSHOTS__S3__SECRET_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - QDRANT__STORAGE__SNAPSHOTS__S3__ENDPOINT=${S3_ENDPOINT:-}
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"  # REST API
      - "${QDRANT_GRPC_PORT:-6334}:6334"  # gRPC API
    volumes:
      # Comment out the line below if using S3-only storage
      - ${QDRANT_STORAGE_PATH:-./qdrant_storage}:/qdrant/storage
    restart: unless-stopped
    networks:
      - qdrant_network

  api:
    build: ./api
    container_name: qdrant_api
    env_file:
      - .env
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      - qdrant
    volumes:
      - ./api:/app
    networks:
      - qdrant_network
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  web:
    build: ./web
    container_name: qdrant_web_ui
    env_file:
      - .env
    ports:
      - "${WEB_PORT:-3000}:80"
    depends_on:
      - api
    volumes:
      - ./web/index.html:/usr/share/nginx/html/index.html
    networks:
      - qdrant_network

networks:
  qdrant_network:
    driver: bridge

volumes:
  qdrant_storage: